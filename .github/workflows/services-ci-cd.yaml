name: Planify Microservices - CI/CD

on:
    push:
        branches: [main, dev]
        paths:
            - "services/**"
            - ".github/workflows/services-ci-cd.yaml"
    pull_request:
        branches: [main, dev]
        paths:
            - "services/**"

env:
    REGISTRY: ghcr.io

jobs:
    # Job 1: Detect Changed Services
    detect-changes:
        name: Detect Changed Services
        runs-on: ubuntu-latest
        outputs:
            services: ${{ steps.filter.outputs.changes }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check which services changed
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      event-manager-service:
                        - 'services/event-manager-service/**'
                      guest-service:
                        - 'services/guest-service/**'
                      booking-service:
                        - 'services/booking-service/**'
                      notification-service:
                        - 'services/notification-service/**'
                      analytics-service:
                        - 'services/analytics-service/**'
                      user-service:
                        - 'services/user-service/**'

    # Job 2: Build and Test (runs for each changed service)
    build-and-test:
        name: Build & Test
        needs: detect-changes
        runs-on: ubuntu-latest
        if: needs.detect-changes.outputs.services != '[]'

        strategy:
            matrix:
                service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
            fail-fast: false # Continue even if one service fails

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_PASSWORD: planify
                    POSTGRES_USER: planify
                    POSTGRES_DB: planify
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: maven

            - name: Build ${{ matrix.service }}
              run: |
                  cd services/${{ matrix.service }}
                  chmod +x mvnw
                  ./mvnw clean install -DskipTests

            - name: Run tests for ${{ matrix.service }}
              run: |
                  cd services/${{ matrix.service }}
                  ./mvnw test

            - name: Upload build artifacts
              if: success()
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.service }}-jar
                  path: services/${{ matrix.service }}/target/*.jar
                  retention-days: 5

    # Job 3: Build Docker Images (only for dev/main)
    build-docker:
        name: Build Docker Image
        needs: [detect-changes, build-and-test]
        runs-on: ubuntu-latest
        if: |
            needs.detect-changes.outputs.services != '[]' &&
            github.event_name == 'push' &&
            (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')

        strategy:
            matrix:
                service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
            fail-fast: false

        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/planify-${{ matrix.service }}
                  tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

            - name: Build and push ${{ matrix.service }}
              uses: docker/build-push-action@v5
              with:
                  context: ./services/${{ matrix.service }}
                  file: ./services/${{ matrix.service }}/Dockerfile
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}

            - name: Image Summary
              run: |
                  echo "### Docker Image: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    # Job 4: Deploy to Kubernetes (DISABLED for now)
    deploy-to-k8s:
        name: Deploy to Kubernetes
        needs: [detect-changes, build-docker]
        runs-on: ubuntu-latest
        if: false # Enable when AKS cluster is ready

        strategy:
            matrix:
                service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
            fail-fast: false

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Deployment Placeholder for ${{ matrix.service }}
              run: |
                  echo "=== Kubernetes deployment not yet configured ==="
                  echo "Service: ${{ matrix.service }}"
                  echo "Branch: ${{ github.ref_name }}"
                  echo "Image: ${{ env.REGISTRY }}/${{ github.repository_owner }}/planify-${{ matrix.service }}:${{ github.ref_name }}"
